<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>POS Táctil</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"/>

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="/css/styles.css"/>

    <style>
        body {
            background-color: #f8f9fa;
            font-size: 1.3rem;
        }

        h1, h3 {
            font-weight: 700;
        }

        .table td, .table th {
            font-size: 1.1rem;
            vertical-align: middle;
            padding: 1rem;
        }

        .panel-boton {
            display: inline-block;
            padding: 2rem 4rem;
            background-color: #198754;
            color: white;
            border-radius: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            text-decoration: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.2s ease;
            margin-top: 10px;
        }

        .panel-boton:hover {
            transform: scale(1.05);
            background-color: #157347;
            text-decoration: none;
            color: white;
        }

        .table th {
            background-color: #e9ecef;
        }

        .cerrar-caja-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        #cerrarCaja {
            display: none;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white mb-4">
        <a class="navbar-brand fs-3 fw-bold" href="#">POS Táctil</a>
    </nav>

    <!-- Encabezado -->
    <div class="text-center animate__animated animate__fadeIn">
        <h1 class="display-3 mb-3">Bienvenido</h1>
        <p class="lead fs-4">Gestiona tus ventas con una interfaz adaptada para pantallas táctiles.</p>
    </div>

    <!-- Resumen de Cajas -->
    <div class="mt-5 animate__animated animate__fadeInUp">
        <h3 class="mb-3">Cajas Anteriores</h3>
        <div class="table-responsive">
            <table class="table table-hover border">
                <thead>
                <tr>
                    <th># Caja</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Cierre</th>
                    <th>Total Ventas</th>
                </tr>
                </thead>
                <tbody id="resumenCajas">
                <!-- Se rellenará dinámicamente -->
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-center mt-3">
            <button id="prevPagina" class="btn btn-outline-secondary me-2">←</button>
            <button id="sigPagina" class="btn btn-outline-secondary">→</button>
        </div>
    </div>

    <!-- Botones Abrir y Cerrar Caja -->
    <div class="cerrar-caja-container">
        <button id="abrirCaja" class="panel-boton">Abrir Caja</button>
        <button id="cerrarCaja" class="panel-boton">Cerrar Caja</button>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let cajaAbierta = false;
    let todasLasCajas = [];
    let paginaActual = 0;
    const cajasPorPagina = 5;

    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/caja')
            .then(response => response.json())
            .then(data => {
                todasLasCajas = data.reverse(); // Guardamos todas las cajas ordenadas
                mostrarPagina(paginaActual);
            })
            .catch(err => {
                console.error("Error al cargar sesiones de caja:", err);
            });

        document.getElementById("prevPagina").addEventListener("click", () => {
            if (paginaActual > 0) {
                paginaActual--;
                mostrarPagina(paginaActual);
            }
        });

        document.getElementById("sigPagina").addEventListener("click", () => {
            const totalPaginas = Math.ceil(todasLasCajas.length / cajasPorPagina);
            if (paginaActual < totalPaginas - 1) {
                paginaActual++;
                mostrarPagina(paginaActual);
            }
        });

        document.getElementById("abrirCaja").addEventListener("click", () => {
            if (cajaAbierta) {
                alert("Ya hay una caja abierta.");
                return;
            }
            fetch('/api/caja/abrir', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = "/caja.html";
                    } else {
                        alert("No se puede abrir una nueva caja. Es posible que ya haya una abierta.");
                    }
                })
                .catch(err => {
                    console.error("Error al abrir caja:", err);
                    alert("Error al abrir la caja.");
                });
        });

        document.getElementById("cerrarCaja").addEventListener("click", () => {
            let totalFactura = 0;
            if (typeof productos !== 'undefined' && Array.isArray(productos)) {
                totalFactura = productos.reduce((total, producto) => total + producto.precio * producto.cantidad, 0);
            }

            fetch(`/api/caja/cerrar?totalVentas=${totalFactura.toFixed(2)}`, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        alert("Caja cerrada correctamente.");
                        cajaAbierta = false;
                        document.getElementById("cerrarCaja").style.display = 'none';
                        return fetch('/api/caja');
                    } else {
                        alert("Error al cerrar la caja.");
                    }
                })
                .then(response => response.json())
                .then(data => {
                    todasLasCajas = data.reverse();
                    paginaActual = 0;
                    mostrarPagina(paginaActual);
                })
                .catch(err => {
                    console.error("Error al actualizar la tabla de cajas:", err);
                });
        });
    });

    function mostrarPagina(pagina) {
        const tabla = document.getElementById("resumenCajas");
        tabla.innerHTML = "";

        const inicio = pagina * cajasPorPagina;
        const fin = inicio + cajasPorPagina;
        const cajasPagina = todasLasCajas.slice(inicio, fin);

        cajasPagina.forEach(caja => {
            const row = document.createElement("tr");

            const id = caja.id.toString().padStart(4, '0');
            const fechaApertura = new Date(caja.fechaApertura).toLocaleString();
            const fechaCierre = caja.fechaCierre
                ? new Date(caja.fechaCierre).toLocaleString()
                : "—";
            const total = caja.totalVentas != null
                ? `$${parseFloat(caja.totalVentas).toFixed(2)}`
                : "—";

            row.innerHTML = `
                <td>${id}</td>
                <td>${fechaApertura}</td>
                <td>${fechaCierre}</td>
                <td>${total}</td>
            `;
            tabla.appendChild(row);

            if (caja.estado === 'ABIERTA') {
                cajaAbierta = true;
                document.getElementById("cerrarCaja").style.display = 'inline-block';
            }
        });
    }
</script>

</body>
</html>

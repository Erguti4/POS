<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>POS Táctil</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"/>

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="/css/styles.css"/>

    <style>
        body {
            background: linear-gradient(to bottom right, #ffe0b2, #fefefe); /* beige medio a blanco */
            font-size: 1.3rem;
        }

        h1, h3 {
            font-weight: 700;
        }

        .table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background-color: #ffb74d; /* tono naranja suave */
            color: #212529;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
        }

        .table tbody tr {
            transition: background-color 0.3s ease;
        }

        .table tbody tr:nth-child(even) {
            background-color: #fff3e0;
        }

        .table tbody tr:nth-child(odd) {
            background-color: #ffe0b2;
        }

        .table tbody tr:hover {
            background-color: #ffe0b2;
        }

        .table td {
            text-align: center;
            font-size: 1.1rem;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }



        .panel-boton {
            display: inline-block;
            padding: 2rem 4rem;
            background-color: #198754;
            color: white;
            border-radius: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            text-decoration: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.2s ease;
            margin-top: 10px;
        }

        .panel-boton:hover {
            transform: scale(1.05);
            background-color: #157347;
            text-decoration: none;
            color: white;
        }

        .cerrar-caja-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        #cerrarCaja {
            display: none;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg shadow-sm bg-light px-4 py-3 rounded mb-4">
        <a class="navbar-brand d-flex align-items-center fs-2 fw-bold text-success" href="#">
            <i class="bi bi-cash-register me-2"></i> POS Táctil
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ms-auto">
                <!-- Otras opciones de navegación aquí -->
            </ul>

            <!-- Botón para personalizar ticket -->
            <a href="personalizar-ticket.html" class="btn btn-warning ms-3 my-2 my-lg-0">
                <i class="bi bi-paint-bucket me-2"></i> Personalizar Ticket
            </a>
        </div>
    </nav>


    <!-- Encabezado -->
    <div class="text-center animate__animated animate__fadeIn animate__delay-1s">
        <h1 class="display-3 mb-3">Bienvenido</h1>
        <p class="lead fs-4">Gestiona tus ventas con una interfaz adaptada para pantallas táctiles.</p>
    </div>

    <!-- Resumen de Cajas -->
    <div class="mt-5 animate__animated animate__fadeInUp">
        <h3 class="mb-3">Cajas Anteriores</h3>
        <div class="table-responsive">
            <table class="table table-hover border">
                <thead>
                <tr>
                    <th># Caja</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Cierre</th>
                    <th>Total Ventas</th>
                </tr>
                </thead>
                <tbody id="resumenCajas">
                <!-- Se rellenará dinámicamente -->
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-center mt-3">
            <button id="prevPagina" class="btn btn-outline-secondary btn-lg px-4 py-2 me-3 fs-3">←</button>
            <button id="sigPagina" class="btn btn-outline-secondary btn-lg px-4 py-2 fs-3">→</button>
        </div>
    </div>

    <!-- Botones Abrir y Cerrar Caja -->
    <div class="cerrar-caja-container">
        <button id="abrirCaja" class="panel-boton animate__animated">Abrir Caja</button>
        <button id="cerrarCaja" class="panel-boton animate__animated">Cerrar Caja</button>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let cajaAbierta = false;
    let todasLasCajas = [];
    let paginaActual = 0;
    const cajasPorPagina = 5;

    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/caja')
            .then(response => response.json())
            .then(data => {
                todasLasCajas = data.reverse(); // Guardamos todas las cajas ordenadas
                mostrarPagina(paginaActual);
            })
            .catch(err => {
                console.error("Error al cargar sesiones de caja:", err);
            });

        document.getElementById("prevPagina").addEventListener("click", () => {
            if (paginaActual > 0) {
                paginaActual--;
                mostrarPagina(paginaActual);
            }
        });

        document.getElementById("sigPagina").addEventListener("click", () => {
            const totalPaginas = Math.ceil(todasLasCajas.length / cajasPorPagina);
            if (paginaActual < totalPaginas - 1) {
                paginaActual++;
                mostrarPagina(paginaActual);
            }
        });

        document.getElementById("abrirCaja").addEventListener("click", () => {
            if (cajaAbierta) {
                alert("Ya hay una caja abierta.");
                return;
            }
            fetch('/api/caja/abrir', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = "/caja.html";
                    } else {
                        alert("No se puede abrir una nueva caja. Es posible que ya haya una abierta.");
                    }
                })
                .catch(err => {
                    console.error("Error al abrir caja:", err);
                    alert("Error al abrir la caja.");
                });
        });

        document.getElementById("cerrarCaja").addEventListener("click", () => {
            let totalFactura = 0;
            if (typeof productos !== 'undefined' && Array.isArray(productos)) {
                totalFactura = productos.reduce((total, producto) => total + producto.precio * producto.cantidad, 0);
            }

            fetch(`/api/caja/cerrar?totalVentas=${totalFactura.toFixed(2)}`, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        alert("Caja cerrada correctamente.");
                        cajaAbierta = false;
                        document.getElementById("cerrarCaja").style.display = 'none';
                        return fetch('/api/caja');
                    } else {
                        alert("Error al cerrar la caja.");
                    }
                })
                .then(response => response.json())
                .then(data => {
                    todasLasCajas = data.reverse();
                    paginaActual = 0;
                    mostrarPagina(paginaActual);
                })
                .catch(err => {
                    console.error("Error al actualizar la tabla de cajas:", err);
                });
        });
    });

    function mostrarPagina(pagina) {
        const tabla = document.getElementById("resumenCajas");
        tabla.innerHTML = "";

        const inicio = pagina * cajasPorPagina;
        const fin = inicio + cajasPorPagina;
        const cajasPagina = todasLasCajas.slice(inicio, fin);

        cajasPagina.forEach((caja, index) => {
            const row = document.createElement("tr");

            // Añadir clase de animación a cada fila con retraso
            row.classList.add('animate__animated', 'animate__fadeInUp', `animate__delay-${index}s`);


            const id = caja.id.toString().padStart(4, '0');
            const fechaApertura = new Date(caja.fechaApertura).toLocaleString();
            const fechaCierre = caja.fechaCierre
                ? new Date(caja.fechaCierre).toLocaleString()
                : "—";
            const total = caja.totalVentas != null
                ? `$${parseFloat(caja.totalVentas).toFixed(2)}`
                : "—";

            row.innerHTML = `
            <td>${id}</td>
            <td>${fechaApertura}</td>
            <td>${fechaCierre}</td>
            <td>${total}</td>
        `;
            tabla.appendChild(row);

            if (caja.estado === 'ABIERTA') {
                cajaAbierta = true;
                document.getElementById("cerrarCaja").style.display = 'inline-block';
            }
        });
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Facturas</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" />

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="/css/styles.css" />

    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <style>
        body {
            background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
            font-size: 1.3rem;
        }

        h1, h3 {
            font-weight: 700;
        }

        .table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background-color: #4caf50;
            color: #fff;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
        }

        .table tbody tr {
            transition: background-color 0.3s ease;
        }

        .table tbody tr:nth-child(even) {
            background-color: #f1f8e9;
        }

        .table tbody tr:nth-child(odd) {
            background-color: #e8f5e9;
        }

        .table tbody tr:hover {
            background-color: #c8e6c9;
        }

        .table td {
            text-align: center;
            font-size: 1.1rem;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
    </style>
</head>

<body>
<div class="container py-5">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg shadow-sm bg-light px-4 py-3 rounded mb-4">
        <a class="navbar-brand d-flex align-items-center fs-2 fw-bold text-success" href="#">
            <i class="bi bi-file-earmark-text me-2"></i> Facturas
        </a>
        <a href="javascript:history.back()" class="btn btn-primary ms-auto my-2 my-lg-0">
            <i class="bi bi-arrow-left ms-2 fs-4"></i>
        </a>

    </nav>

    <!-- Encabezado -->
    <div class="text-center animate__animated animate__fadeIn animate__delay-1s">
        <h1 class="display-3 mb-3">Gestión de Facturas</h1>
        <p class="lead fs-4">Visualiza las facturas generadas y sus productos asociados.</p>
    </div>

    <!-- Facturas -->
    <div class="mt-5 animate__animated animate__fadeInUp">
        <h3 class="mb-3">Lista de Facturas</h3>
        <div class="table-responsive">
            <table class="table table-hover border">
                <thead>
                <tr>
                    <th>Factura ID</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Productos</th>
                </tr>
                </thead>
                <tbody id="facturasLista">
                <!-- Aquí se rellenarán las facturas dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    <div class="d-flex justify-content-center mt-3">
        <button id="prevPagina" class="btn btn-outline-secondary btn-lg px-4 py-2 me-3 fs-3">←</button>
        <button id="sigPagina" class="btn btn-outline-secondary btn-lg px-4 py-2 fs-3">→</button>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let facturas = [];
    let paginaActual = 0;
    const facturasPorPagina = 6;

    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/factura')  // Asegúrate de que este endpoint retorne las facturas con los productos asociados
            .then(response => response.json())
            .then(data => {
                facturas = data;
                mostrarPagina(paginaActual);
            })
            .catch(err => {
                console.error("Error al cargar facturas:", err);
            });

        document.getElementById("prevPagina").addEventListener("click", () => {
            if (paginaActual > 0) {
                paginaActual--;
                mostrarPagina(paginaActual);
            }
        });

        document.getElementById("sigPagina").addEventListener("click", () => {
            const totalPaginas = Math.ceil(facturas.length / facturasPorPagina);
            if (paginaActual < totalPaginas - 1) {
                paginaActual++;
                mostrarPagina(paginaActual);
            }
        });
    });

    function mostrarPagina(pagina) {
        const tabla = document.getElementById("facturasLista");
        tabla.innerHTML = "";

        const inicio = pagina * facturasPorPagina;
        const fin = inicio + facturasPorPagina;
        const facturasPagina = facturas.slice(inicio, fin);

        facturasPagina.forEach((factura, index) => {
            const row = document.createElement("tr");

            // Añadir clase de animación a cada fila con retraso
            row.classList.add('animate__animated', 'animate__fadeInUp', `animate__delay-${index}s`);

            const productos = factura.productos.map(producto => {
                return `<tr>
                            <td>${producto.nombre}</td>
                            <td>${producto.precio}</td>
                            <td>${producto.cantidad}</td>
                        </tr>`;
            }).join('');

            // Formatear fecha con hora, minuto y segundo
            const fecha = new Date(factura.fecha);
            const fechaFormateada = `${fecha.toLocaleDateString()} ${fecha.getHours()}:${fecha.getMinutes()}:${fecha.getSeconds()}`;

            row.innerHTML = `
                <td>${factura.id}</td>
                <td>${fechaFormateada}</td>
                <td>${factura.total.toFixed(2)}€</td>
                <td>
                    <button class="btn btn-info" onclick="verProductos(${factura.id})">Ver Productos</button>
                    <button class="btn btn-success" onclick="imprimirFactura(${factura.id})">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                    <div id="productosFactura${factura.id}" class="productos-factura" style="display: none;">
                        <table class="table mt-3">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productos}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;
            tabla.appendChild(row);
        });
    }

    function verProductos(facturaId) {
        const productosFactura = document.getElementById(`productosFactura${facturaId}`);
        productosFactura.style.display = productosFactura.style.display === 'none' ? 'block' : 'none';
    }


    async function imprimirFactura(facturaId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const anchoPagina = doc.internal.pageSize.getWidth();
        let y = 10;

        // Obtener la factura correspondiente
        const factura = facturas.find(f => f.id === facturaId);
        if (!factura) return;

        const totalFactura = factura.total;
        const productos = factura.productos;

        // Obtener personalización
        const personalizacion = await fetch('/ticket-personalizado')
            .then(response => response.json())
            .catch(error => {
                console.error('Error al cargar la personalización:', error);
                return {};
            });

        const { logoUrl, fontSize, fontType, showDate, customText } = personalizacion;

        const fuente = fontType || "Helvetica";
        const tamanoFuente = fontSize || 12;

        doc.setFont(fuente, "normal");
        doc.setFontSize(tamanoFuente);

        // Logo
        if (logoUrl) {
            try {
                const logoImg = await loadImage(logoUrl);
                const logoAncho = 90;
                const logoAlto = 60;
                doc.addImage(logoImg, 'JPEG', (anchoPagina - logoAncho) / 2, y, logoAncho, logoAlto);
                y += logoAlto + 10;
            } catch (error) {
                console.error('Error al cargar el logo:', error);
            }
        }

        // Texto personalizado
        if (customText) {
            const lineas = splitTextToLines(doc, customText, 180);
            lineas.forEach(linea => {
                doc.setFont(undefined, "italic");
                doc.text(linea, anchoPagina / 2, y, { align: "center" });
                y += 6;
            });
            y += 8;
        }

        // Teléfono y NIF
        doc.setFontSize(tamanoFuente + 2);
        doc.setFont(undefined, "bold");
        doc.text(`Telf.954 17 17 16`, 10, y);
        doc.text(`NIF: 28742186-Y`, 130, y);
        y += 20;

        // Número de factura
        doc.setFontSize(tamanoFuente + 15);
        doc.setFont(undefined, "bold");
        doc.text(`Factura Nº ${factura.id}`, 10, y);
        y += 8;

        // Título
        doc.setFontSize(tamanoFuente - 5);
        doc.setFont(undefined, "normal");
        doc.text("FACTURA SIMPLIFICADA", 10, y);

        // Fecha
        if (showDate) {
            const fecha = new Date(factura.fecha).toLocaleString();
            doc.setFontSize(tamanoFuente - 1);
            doc.setFont(undefined, "normal");
            doc.text(`${fecha}`, 130, y);
            y += 20;
        }

        // Encabezados de tabla
        doc.setFontSize(tamanoFuente + 1);
        doc.setFont(undefined, "bold");
        doc.text("Producto", 10, y);
        doc.text("Cant.", 90, y);
        doc.text("Desc.", 120, y);
        doc.text("Importe", 160, y);
        doc.line(10, y + 2, anchoPagina - 10, y + 2);
        y += 10;

        // Detalle de productos
        doc.setFont(undefined, "normal");
        productos.forEach(prod => {
            const descuento = prod.descuento || 0;
            const precioConDescuento = prod.precio * (1 - descuento / 100);
            const totalProductoConDescuento = (precioConDescuento * prod.cantidad).toFixed(2);

            const nombre = prod.nombre.length > 20 ? prod.nombre.slice(0, 20) + "…" : prod.nombre;
            y += 4;
            doc.text(nombre, 10, y);
            doc.text(prod.cantidad.toString(), 100, y, { align: "right" });
            doc.text(descuento ? `${descuento}%` : "-", 140, y, { align: "right" });
            doc.text(`${totalProductoConDescuento}€`, 190, y, { align: "right" });
            y += 7;
        });

        doc.line(10, y, anchoPagina - 10, y);
        y += 30;

        // Total final
        doc.setFont(undefined, "bold");
        doc.setFontSize(tamanoFuente + 15);
        doc.text("TOTAL", 80, y);
        doc.text(`${totalFactura.toFixed(2)}€`, 190, y, { align: "right" });
        y += 10;
        doc.line(10, y, anchoPagina - 10, y);

        // Base imponible e IVA
        const porcentajeIVA = 21;
        const totalSinIVA = totalFactura / (1 + porcentajeIVA / 100);
        const totalIVA = totalFactura - totalSinIVA;
        y += 10;

        doc.setFontSize(tamanoFuente);
        doc.setFont(undefined, "normal");
        doc.text("Base imponible.", 80, y);
        doc.text(`% IVA (${porcentajeIVA}%)`, 145, y);
        y += 10;

        doc.text(`${totalSinIVA.toFixed(2)}€`, 135, y, { align: "right" });
        doc.text(`${totalIVA.toFixed(2)}€`, 190, y, { align: "right" });
        y += 20;
        doc.line(10, y, anchoPagina - 10, y);
        y += 10;

        // Agradecimiento
        doc.setFontSize(tamanoFuente - 1);
        doc.text("GRACIAS POR SU COMPRA", anchoPagina / 2, y, { align: "center" });
        y += 8;

        // Condiciones
        doc.setFontSize(tamanoFuente - 3);
        doc.text("Ticket obligatorio para cambios de 7 días después de la compra", 10, y);
        y += 8;
        doc.text("No se devuelve  el   dinero, se   canjea   por   un   vale  de   caja", 10, y);
        y += 8;
        doc.text("Garantía del producto  según   normativa   vigente   24  MESES", 10, y);

        // Abrir o guardar
        doc.autoPrint();
        window.open(doc.output('bloburl'), '_blank');
    }

    function loadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = url;
        });
    }

    function splitTextToLines(doc, text, maxWidth) {
        return doc.splitTextToSize(text, maxWidth);
    }




</script>

</body>
</html>

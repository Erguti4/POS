<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Facturas</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" />

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="/css/styles.css" />

    <style>
        body {
            background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
            font-size: 1.3rem;
        }

        h1, h3 {
            font-weight: 700;
        }

        .table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background-color: #4caf50;
            color: #fff;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
        }

        .table tbody tr {
            transition: background-color 0.3s ease;
        }

        .table tbody tr:nth-child(even) {
            background-color: #f1f8e9;
        }

        .table tbody tr:nth-child(odd) {
            background-color: #e8f5e9;
        }

        .table tbody tr:hover {
            background-color: #c8e6c9;
        }

        .table td {
            text-align: center;
            font-size: 1.1rem;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
    </style>
</head>

<body>
<div class="container py-5">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg shadow-sm bg-light px-4 py-3 rounded mb-4">
        <a class="navbar-brand d-flex align-items-center fs-2 fw-bold text-success" href="#">
            <i class="bi bi-file-earmark-text me-2"></i> Facturas
        </a>
    </nav>

    <!-- Encabezado -->
    <div class="text-center animate__animated animate__fadeIn animate__delay-1s">
        <h1 class="display-3 mb-3">Gestión de Facturas</h1>
        <p class="lead fs-4">Visualiza las facturas generadas y sus productos asociados.</p>
    </div>

    <!-- Facturas -->
    <div class="mt-5 animate__animated animate__fadeInUp">
        <h3 class="mb-3">Lista de Facturas</h3>
        <div class="table-responsive">
            <table class="table table-hover border">
                <thead>
                <tr>
                    <th>Factura ID</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Productos</th>
                </tr>
                </thead>
                <tbody id="facturasLista">
                <!-- Aquí se rellenarán las facturas dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    <div class="d-flex justify-content-center mt-3">
        <button id="prevPagina" class="btn btn-outline-secondary btn-lg px-4 py-2 me-3 fs-3">←</button>
        <button id="sigPagina" class="btn btn-outline-secondary btn-lg px-4 py-2 fs-3">→</button>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let facturas = [];
    let paginaActual = 0;
    const facturasPorPagina = 6;

    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/factura')  // Asegúrate de que este endpoint retorne las facturas con los productos asociados
            .then(response => response.json())
            .then(data => {
                facturas = data;
                mostrarPagina(paginaActual);
            })
            .catch(err => {
                console.error("Error al cargar facturas:", err);
            });

        document.getElementById("prevPagina").addEventListener("click", () => {
            if (paginaActual > 0) {
                paginaActual--;
                mostrarPagina(paginaActual);
            }
        });

        document.getElementById("sigPagina").addEventListener("click", () => {
            const totalPaginas = Math.ceil(facturas.length / facturasPorPagina);
            if (paginaActual < totalPaginas - 1) {
                paginaActual++;
                mostrarPagina(paginaActual);
            }
        });
    });

    function mostrarPagina(pagina) {
        const tabla = document.getElementById("facturasLista");
        tabla.innerHTML = "";

        const inicio = pagina * facturasPorPagina;
        const fin = inicio + facturasPorPagina;
        const facturasPagina = facturas.slice(inicio, fin);

        facturasPagina.forEach((factura, index) => {
            const row = document.createElement("tr");

            // Añadir clase de animación a cada fila con retraso
            row.classList.add('animate__animated', 'animate__fadeInUp', `animate__delay-${index}s`);

            const productos = factura.productos.map(producto => {
                return `<tr>
                            <td>${producto.nombre}</td>
                            <td>${producto.precio}</td>
                            <td>${producto.cantidad}</td>
                        </tr>`;
            }).join('');

            // Formatear fecha con hora, minuto y segundo
            const fecha = new Date(factura.fecha);
            const fechaFormateada = `${fecha.toLocaleDateString()} ${fecha.getHours()}:${fecha.getMinutes()}:${fecha.getSeconds()}`;

            row.innerHTML = `
                <td>${factura.id}</td>
                <td>${fechaFormateada}</td>
                <td>${factura.total.toFixed(2)}€</td>
                <td>
                    <button class="btn btn-info" onclick="verProductos(${factura.id})">Ver Productos</button>
                    <div id="productosFactura${factura.id}" class="productos-factura" style="display: none;">
                        <table class="table mt-3">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productos}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;
            tabla.appendChild(row);
        });
    }

    function verProductos(facturaId) {
        const productosFactura = document.getElementById(`productosFactura${facturaId}`);
        productosFactura.style.display = productosFactura.style.display === 'none' ? 'block' : 'none';
    }
</script>

</body>
</html>
